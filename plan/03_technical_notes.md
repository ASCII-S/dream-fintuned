# Dreamæ‰©æ•£æ¨¡å‹æŠ€æœ¯è¦ç‚¹åˆ†æ

---

## ğŸ§  æ‰©æ•£æ¨¡å‹ vs è‡ªå›å½’æ¨¡å‹

### è‡ªå›å½’æ¨¡å‹ï¼ˆä¼ ç»ŸLLMï¼Œå¦‚GPTï¼‰

```
ç”Ÿæˆè¿‡ç¨‹ï¼šé€ä¸ªtokenç”Ÿæˆ
t=1: [START] â†’ "ä»Š"
t=2: [START, ä»Š] â†’ "å¤©"
t=3: [START, ä»Š, å¤©] â†’ "å¤©"
t=4: [START, ä»Š, å¤©, å¤©] â†’ "æ°”"
...

ç‰¹ç‚¹ï¼š
âœ“ ç”Ÿæˆè´¨é‡é«˜
âœ“ è®­ç»ƒç¨³å®š
âœ— æ¨ç†é€Ÿåº¦æ…¢ï¼ˆä¸²è¡Œç”Ÿæˆï¼‰
âœ— æ— æ³•å¹¶è¡Œç”Ÿæˆ
```

### æ‰©æ•£æ¨¡å‹ï¼ˆDreamï¼‰

```
ç”Ÿæˆè¿‡ç¨‹ï¼šä»å™ªå£°é€æ­¥å»å™ªåˆ°æ–‡æœ¬

Step 0 (åˆå§‹çŠ¶æ€):
[MASK, MASK, MASK, MASK, MASK] (å…¨éƒ¨masked)

Step 1 (ç¬¬ä¸€æ¬¡å»å™ª):
[ä»Š, MASK, MASK, MASK, MASK] (ç”Ÿæˆéƒ¨åˆ†token)

Step 2:
[ä»Š, å¤©, MASK, æ°”, MASK] (ç»§ç»­å¡«å……)

Step 3:
[ä»Š, å¤©, å¤©, æ°”, å¥½] (å®Œå…¨å¡«å……)

ç‰¹ç‚¹ï¼š
âœ“ å¯ä»¥å¹¶è¡Œç”Ÿæˆå¤šä¸ªtoken
âœ“ ç”Ÿæˆé€Ÿåº¦å¯è°ƒï¼ˆstepsæ•°é‡ï¼‰
âœ“ æ”¯æŒå¡«å……ä»»åŠ¡ï¼ˆinfillingï¼‰
âœ— è®­ç»ƒå¤æ‚åº¦è¾ƒé«˜
âœ— éœ€è¦ç‰¹æ®Šçš„é‡‡æ ·ç­–ç•¥
```

---

## ğŸ”„ Dreamçš„æ ¸å¿ƒæœºåˆ¶

### 1. æ‰©æ•£é‡‡æ ·è¿‡ç¨‹

Dreamä½¿ç”¨**ç¦»æ•£æ‰©æ•£**ï¼ˆdiscrete diffusionï¼‰è€Œéè¿ç»­æ‰©æ•£ï¼š

```python
# ç®€åŒ–ç‰ˆä¼ªä»£ç 
def diffusion_generate(model, input_ids, max_new_tokens, steps):
    # 1. åˆå§‹åŒ–ï¼šæ‰€æœ‰è¦ç”Ÿæˆçš„ä½ç½®éƒ½æ˜¯MASK
    output_tokens = [MASK] * max_new_tokens
    
    # 2. è¿­ä»£å»å™ª
    for step in range(steps):
        # é¢„æµ‹æ¯ä¸ªMASKä½ç½®çš„tokenæ¦‚ç‡
        logits = model(input_ids + output_tokens)
        
        # è®¡ç®—æ¯ä¸ªä½ç½®çš„ç½®ä¿¡åº¦
        confidences = compute_confidence(logits)
        
        # é€‰æ‹©è¦å¡«å……çš„ä½ç½®ï¼ˆremaskingç­–ç•¥ï¼‰
        num_to_unmask = schedule(step, steps, max_new_tokens)
        positions = select_positions(confidences, num_to_unmask)
        
        # é‡‡æ ·æ–°token
        for pos in positions:
            output_tokens[pos] = sample(logits[pos])
    
    return output_tokens
```

### 2. Remaskingç­–ç•¥è¯¦è§£

**ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | ç½®ä¿¡åº¦è®¡ç®— | é€‚ç”¨åœºæ™¯ | æ•ˆæœ |
|-----|----------|---------|-----|
| `origin` | éšæœºé€‰æ‹© | é€šç”¨ | åŸºçº¿ï¼Œæ€§èƒ½è¾ƒå·® |
| `maskgit_plus` | max(p) | éœ€è¦å¿«é€Ÿç”Ÿæˆ | é€Ÿåº¦å¿«ï¼Œè´¨é‡ä¸­ç­‰ |
| `entropy` | -Î£pÂ·log(p) | æ¨ç†ä»»åŠ¡ | **æ¨è**ï¼Œè´¨é‡æœ€å¥½ |
| `topk_margin` | p1 - p2 | é«˜è´¨é‡ç”Ÿæˆ | è´¨é‡å¥½ï¼Œç¨æ…¢ |

**Entropyç­–ç•¥ç¤ºä¾‹**ï¼š
```python
# å¯¹æ¯ä¸ªMASKä½ç½®è®¡ç®—ç†µ
position_1: [0.8, 0.1, 0.05, 0.05] â†’ entropy = 0.74 (ä½ç†µ=é«˜ç½®ä¿¡åº¦)
position_2: [0.3, 0.3, 0.2, 0.2]   â†’ entropy = 1.97 (é«˜ç†µ=ä½ç½®ä¿¡åº¦)

# ä¼˜å…ˆå¡«å……ä½ç†µï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰çš„ä½ç½®
â†’ å…ˆå¡«å…… position_1
```

### 3. æ—¶é—´é‡åŠ æƒï¼ˆTime Reweightingï¼‰

Dreamä½¿ç”¨`cart`ï¼ˆConstant Adaptive ReweighTingï¼‰ç­–ç•¥æ¥å¹³è¡¡ä¸åŒæ—¶é—´æ­¥çš„è®­ç»ƒæŸå¤±ï¼š

```python
# é…ç½®ä¸­çš„å‚æ•°
diffusion.time_reweighting=cart

# ä½œç”¨ï¼šè®©æ¨¡å‹åœ¨æ‰€æœ‰æ‰©æ•£æ—¶é—´æ­¥éƒ½èƒ½å¾—åˆ°å……åˆ†è®­ç»ƒ
# é¿å…æŸäº›æ—¶é—´æ­¥è®­ç»ƒä¸è¶³
```

---

## ğŸ“Š æ•°æ®æ ¼å¼è¯¦è§£

### S1KåŸå§‹æ ¼å¼

```json
{
  "question": "Solve: 2x + 5 = 15",
  "answer": "<think>\nLet me solve this step by step:\n1. Start with 2x + 5 = 15\n2. Subtract 5 from both sides: 2x = 10\n3. Divide by 2: x = 5\n</think>\nThe answer is x = 5.",
  "source": "math_problem",
  "difficulty": "easy",
  "thinking_tokens": 150,
  "answer_tokens": 20
}
```

### Dreamè®­ç»ƒæ ¼å¼

```json
{
  "prompt": [
    {
      "role": "system",
      "content": "You are a helpful AI assistant..."
    },
    {
      "role": "user",
      "content": "Solve: 2x + 5 = 15"
    }
  ],
  "response": "<think>\nLet me solve this step by step...\n</think>\nThe answer is x = 5."
}
```

**å…³é”®ç‚¹**ï¼š
- `prompt`ï¼šåŒ…å«systemå’Œuseræ¶ˆæ¯çš„åˆ—è¡¨
- `response`ï¼šå®Œæ•´çš„assistantå›å¤ï¼ˆåŒ…å«thinkingè¿‡ç¨‹ï¼‰
- S1Kçš„thinkingè¿‡ç¨‹ç”¨`<think>`æ ‡ç­¾åŒ…è£¹ï¼Œè¿™å¯¹è®­ç»ƒæ¨ç†èƒ½åŠ›å¾ˆé‡è¦

---

## âš™ï¸ è®­ç»ƒå‚æ•°è¯´æ˜

### å…³é”®è¶…å‚æ•°

```bash
# å­¦ä¹ ç‡ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
optim.lr=2e-6  
# Dreamå»ºè®®ï¼š1e-6 åˆ° 5e-6
# å¤ªå¤§ï¼šè®­ç»ƒä¸ç¨³å®š
# å¤ªå°ï¼šæ”¶æ•›å¤ªæ…¢

# Batch size
data.micro_batch_size_per_gpu=4
# æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´ï¼š
# 24GB GPU: 2-4
# 40GB GPU: 4-8
# 80GB GPU: 8-16

# åºåˆ—é•¿åº¦
data.max_length=2048
# Dreamæœ€å¤§æ”¯æŒ2048
# S1Kå¾ˆå¤šæ ·æœ¬è¾ƒé•¿ï¼Œå»ºè®®ä½¿ç”¨2048
# å¦‚æœOOMï¼Œå¯ä»¥é™åˆ°1024

# Epochs
trainer.total_epochs=3
# å»ºè®®ï¼š2-5ä¸ªepoch
# è¿‡å¤šå¯èƒ½è¿‡æ‹Ÿåˆï¼ˆS1Kåªæœ‰1000æ ·æœ¬ï¼‰

# æ¢¯åº¦ç´¯ç§¯ï¼ˆå¦‚æœæ˜¾å­˜ä¸å¤Ÿï¼‰
data.gradient_accumulation_steps=2
# ç­‰æ•ˆäºbatch_size * 2
```

### æ˜¾å­˜ä¼˜åŒ–æŠ€å·§

```python
# 1. æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆå¿…é¡»å¯ç”¨ï¼‰
model.enable_gradient_checkpointing=True
# èŠ‚çœçº¦50%æ˜¾å­˜ï¼Œé€Ÿåº¦é™ä½çº¦20%

# 2. æ··åˆç²¾åº¦è®­ç»ƒï¼ˆé»˜è®¤å¯ç”¨bfloat16ï¼‰
# Dreamè‡ªåŠ¨ä½¿ç”¨torch.bfloat16

# 3. Per-batch cutoffï¼ˆDynamic paddingï¼‰
data.enable_perbatch_cutoff=True
data.perbatch_cutoff_type=random_with_input_pad
# åŠ¨æ€è°ƒæ•´åºåˆ—é•¿åº¦ï¼Œé¿å…æµªè´¹

# 4. FSDPï¼ˆå…¨åˆ†ç‰‡æ•°æ®å¹¶è¡Œï¼‰
# å¤šGPUæ—¶è‡ªåŠ¨å¯ç”¨ï¼Œæ˜¾å­˜èŠ‚çœæ˜¾è‘—
```

### é¢„è®¡æ˜¾å­˜ä½¿ç”¨

| é…ç½® | å•GPUæ˜¾å­˜ | å¤‡æ³¨ |
|-----|-----------|------|
| bs=1, ckpt=True, len=2048 | ~18GB | æœ€ä½é…ç½® |
| bs=2, ckpt=True, len=2048 | ~22GB | æ¨èå•å¡é…ç½® |
| bs=4, ckpt=True, len=2048 | ~30GB | A100æ¨è |
| bs=8, ckpt=False, len=2048 | ~45GB | å¤šå¡åˆ†å¸ƒå¼ |

---

## ğŸ› å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šImportError: cannot import name 'verl'

```bash
# åŸå› ï¼šæ²¡æœ‰å®‰è£…Dreamçš„è®­ç»ƒä¾èµ–
# è§£å†³ï¼š
cd resp/Dream
pip install -e .
```

### é—®é¢˜2ï¼šCUDA Out of Memory

```bash
# è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
1. å‡å°batch_size: 4 â†’ 2 â†’ 1
2. å‡å°max_length: 2048 â†’ 1536 â†’ 1024
3. ç¡®ä¿gradient_checkpointing=True
4. è¿‡æ»¤æ‰è¿‡é•¿çš„è®­ç»ƒæ ·æœ¬
5. ä½¿ç”¨æ›´å¤§çš„GPUæˆ–å¤šGPU
```

### é—®é¢˜3ï¼šè®­ç»ƒLossä¸ä¸‹é™

```bash
# å¯èƒ½åŸå› ä¸è§£å†³ï¼š
1. å­¦ä¹ ç‡è¿‡å° â†’ å¢å¤§åˆ°2e-6æˆ–5e-6
2. å­¦ä¹ ç‡è¿‡å¤§ â†’ å‡å°åˆ°1e-6
3. æ•°æ®æ ¼å¼é”™è¯¯ â†’ æ£€æŸ¥prompt/responseæ ¼å¼
4. æ¨¡å‹åŠ è½½é”™è¯¯ â†’ ç¡®è®¤ä½¿ç”¨Baseæ¨¡å‹è€ŒéInstructæ¨¡å‹
```

### é—®é¢˜4ï¼šç”Ÿæˆè´¨é‡å·®

```python
# è°ƒæ•´ç”Ÿæˆå‚æ•°ï¼š
output = model.diffusion_generate(
    input_ids,
    max_new_tokens=512,
    steps=512,  # å¢åŠ stepsæé«˜è´¨é‡ï¼ˆä½†å˜æ…¢ï¼‰
    temperature=0.2,  # é™ä½temperatureæé«˜ç¡®å®šæ€§
    alg="entropy",  # ä½¿ç”¨entropyç­–ç•¥
    alg_temp=0.0,  # ä¸åŠ éšæœºæ€§
)

# æ¨ç†ä»»åŠ¡æ¨èé…ç½®ï¼š
# steps: 256-512ï¼ˆæ›´å¤šæ›´å¥½ä½†æ›´æ…¢ï¼‰
# temperature: 0.0-0.2ï¼ˆä½æ¸©é«˜è´¨é‡ï¼‰
# alg: "entropy"ï¼ˆæœ€é€‚åˆæ¨ç†ï¼‰
```

### é—®é¢˜5ï¼šTokenizerè­¦å‘Š

```python
# è­¦å‘Šï¼šToken indices sequence length is longer than the specified maximum...
# åŸå› ï¼šæ ·æœ¬é•¿åº¦è¶…è¿‡max_length
# è§£å†³ï¼šåœ¨æ•°æ®å‡†å¤‡é˜¶æ®µè¿‡æ»¤æˆ–æˆªæ–­
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### è®­ç»ƒé€Ÿåº¦ä¼˜åŒ–

1. **ä½¿ç”¨æ›´å¤§çš„batch size**ï¼ˆå¦‚æœæ˜¾å­˜å…è®¸ï¼‰
2. **ä½¿ç”¨å¤šGPU**ï¼š8x GPUå¯ä»¥åŠ é€Ÿ6-7å€
3. **ä½¿ç”¨æ›´å¿«çš„GPU**ï¼šA100 > 4090 > 3090
4. **å‡å°‘éªŒè¯é¢‘ç‡**ï¼š`trainer.val_check_interval=500`
5. **ä½¿ç”¨ç¼–è¯‘ä¼˜åŒ–**ï¼ˆPyTorch 2.0+ï¼‰ï¼š`torch.compile(model)`

### è´¨é‡ä¼˜åŒ–

1. **ä½¿ç”¨å®Œæ•´çš„thinking traces**ï¼šä¿ç•™S1Kä¸­çš„æ¨ç†è¿‡ç¨‹
2. **æ•°æ®æ¸…æ´—**ï¼šè¿‡æ»¤ä½è´¨é‡æ ·æœ¬
3. **Curriculum learning**ï¼šå…ˆè®­ç»ƒç®€å•æ ·æœ¬ï¼Œåè®­ç»ƒå¤æ‚æ ·æœ¬
4. **é€‚å½“å¢åŠ epochs**ï¼š3-5ä¸ªepoché€šå¸¸æ¯”1ä¸ªå¥½
5. **å­¦ä¹ ç‡è°ƒåº¦**ï¼šä½¿ç”¨cosine annealing

---

## ğŸ”¬ å®éªŒå»ºè®®

### åŸºçº¿å®éªŒï¼ˆå¿…åšï¼‰

```bash
# å®éªŒ1ï¼šéªŒè¯ç¯å¢ƒå’Œæ•°æ®
- æˆåŠŸåŠ è½½Dream-Baseæ¨¡å‹
- æˆåŠŸåŠ è½½S1Kæ•°æ®é›†
- æ•°æ®æ ¼å¼è½¬æ¢æ­£ç¡®

# å®éªŒ2ï¼šæœ€å°åŒ–è®­ç»ƒï¼ˆå¿«é€ŸéªŒè¯ï¼‰
- 10%æ•°æ®ï¼Œ1 epoch
- éªŒè¯è®­ç»ƒæµç¨‹å¯è¡Œ
- é¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿ-1å°æ—¶

# å®éªŒ3ï¼šå®Œæ•´è®­ç»ƒ
- 100%æ•°æ®ï¼Œ3 epochs
- å®Œæ•´çš„è®­ç»ƒå’Œè¯„ä¼°
- é¢„è®¡æ—¶é—´ï¼š6-10å°æ—¶ï¼ˆå•GPUï¼‰
```

### è¿›é˜¶å®éªŒï¼ˆå¯é€‰ï¼‰

```bash
# å®éªŒ4ï¼šè¶…å‚æ•°æœç´¢
- å°è¯•ä¸åŒå­¦ä¹ ç‡ï¼š1e-6, 2e-6, 5e-6
- å°è¯•ä¸åŒepochsï¼š2, 3, 5

# å®éªŒ5ï¼šç”Ÿæˆç­–ç•¥å¯¹æ¯”
- å¯¹æ¯”ä¸åŒalgï¼šorigin, entropy, maskgit_plus
- å¯¹æ¯”ä¸åŒstepsï¼š128, 256, 512

# å®éªŒ6ï¼šæ•°æ®æ¶ˆè
- åªç”¨æ•°å­¦é¢˜è®­ç»ƒ
- åªç”¨ç¼–ç¨‹é¢˜è®­ç»ƒ
- å¯¹æ¯”æ•ˆæœå·®å¼‚
```

---

## ğŸ“– æ·±å…¥é˜…è¯»

### å¿…è¯»è®ºæ–‡

1. **Dreamè®ºæ–‡**ï¼šUnderstanding diffusion in LLMs
   - https://arxiv.org/abs/2508.15487
   - é‡ç‚¹ï¼šSection 2-3ï¼ˆæ¨¡å‹æ¶æ„å’Œè®­ç»ƒï¼‰

2. **S1è®ºæ–‡**ï¼šSimple test-time scaling
   - https://arxiv.org/abs/2501.19393
   - é‡ç‚¹ï¼šæ•°æ®é›†æ„å»ºæ–¹æ³•

3. **MaskGIT**ï¼ˆDreamçš„åŸºç¡€ï¼‰ï¼š
   - https://arxiv.org/abs/2202.04200
   - ç†è§£remaskingç­–ç•¥

### å…³é”®ä»£ç æ–‡ä»¶

```bash
# Dreamæ ¸å¿ƒ
resp/Dream/src/diffllm/modeling_diffllm.py  # æ¨¡å‹å®šä¹‰ï¼Œ600è¡Œ
resp/Dream/src/trainer/fsdp_sft_trainer.py  # è®­ç»ƒå¾ªç¯ï¼Œ400è¡Œ

# é‡ç‚¹å…³æ³¨å‡½æ•°ï¼š
- diffusion_generate(): ç”Ÿæˆå‡½æ•°
- forward(): å‰å‘ä¼ æ’­
- compute_loss(): æŸå¤±è®¡ç®—
```

---

## ğŸ’¡ é¢è¯•å±•ç¤ºè¦ç‚¹

é¢è¯•æ—¶é‡ç‚¹å±•ç¤ºå¯¹ä»¥ä¸‹é—®é¢˜çš„ç†è§£ï¼š

### æ¶æ„ç†è§£
1. âœ… Dreamå¦‚ä½•ä½¿ç”¨æ‰©æ•£è¿‡ç¨‹ç”Ÿæˆæ–‡æœ¬ï¼Ÿ
2. âœ… Remaskingç­–ç•¥æœ‰å“ªäº›ï¼Œå„è‡ªä¼˜ç¼ºç‚¹ï¼Ÿ
3. âœ… æ‰©æ•£æ¨¡å‹ç›¸æ¯”è‡ªå›å½’æ¨¡å‹çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ

### å®ç°ç»†èŠ‚
4. âœ… ä¸ºä»€ä¹ˆè¦ä½¿ç”¨gradient checkpointingï¼Ÿ
5. âœ… å¦‚ä½•å¤„ç†å˜é•¿åºåˆ—ï¼Ÿ
6. âœ… è®­ç»ƒæ—¶çš„ä¸»è¦æ˜¾å­˜ç“¶é¢ˆåœ¨å“ªï¼Ÿ

### å®éªŒæ€è€ƒ
7. âœ… è®­ç»ƒè¿‡ç¨‹ä¸­é‡åˆ°çš„æœ€å¤§æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ
8. âœ… å¦‚ä½•è¯„ä¼°å¾®è°ƒæ•ˆæœï¼Ÿ
9. âœ… å¦‚æœé‡æ–°åšï¼Œä½ ä¼šå¦‚ä½•æ”¹è¿›ï¼Ÿ

---

**è®°ä½**ï¼šç†è§£åŸç†æ¯”è°ƒå‚æ›´é‡è¦ï¼é¢è¯•å®˜æ›´å…³å¿ƒä½ çš„æ€è€ƒè¿‡ç¨‹ï¼Œè€Œéæœ€ç»ˆæŒ‡æ ‡ã€‚ 